#!/bin/bash

# Warna
green="\e[38;5;87m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;130m"
orange="\e[38;5;99m"
yellow="\e[38;5;226m"
bold_white="\e[1;37m"
reset="\e[0m"
pink="\e[38;5;205m"

hapus_bot() {
    echo -e "${orange}Menghapus bot lama...${neutral}"
    systemctl stop sellvpn.service 2>/dev/null
    systemctl disable sellvpn.service 2>/dev/null
    rm -f /etc/systemd/system/sellvpn.service
    rm -f /usr/bin/sellvpn /usr/bin/server_sellvpn /etc/cron.d/server_sellvpn
    rm -rf /root/BotVPN2
    if command -v pm2 &> /dev/null; then
        pm2 delete sellvpn &> /dev/null
        pm2 save &> /dev/null
    fi
    systemctl daemon-reload
    echo -e "${green}Bot berhasil dihapus.${neutral}"
}

pasang_package() {
    echo -e "${blue}Memeriksa dan menginstal dependensi...${reset}"

    apt update
    apt install -y npm curl git

    if ! command -v pm2 >/dev/null 2>&1; then
        npm install -g pm2
    fi

    apt install -y build-essential libcairo2-dev libpango1.0-dev libjpeg-dev \
        libgif-dev librsvg2-dev pkg-config libpixman-1-dev
}

setup_bot() {
    echo -e "${pink}Setup konfigurasi bot...${neutral}"

    read -p "Masukkan token bot: " token
    read -p "Masukkan admin ID: " adminid
    read -p "Masukkan nama store: " namastore
    read -p "Masukkan DATA QRIS: " dataqris
    read -p "Masukkan MERCHANT ID: " merchantid
    read -p "Masukkan API KEY: " apikey

    timedatectl set-timezone Asia/Jakarta

    if ! dpkg -s nodejs >/dev/null 2>&1; then
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt install -y nodejs
    fi

    git clone https://github.com/joytun21/BhotVpn.git /root/BotVPN2 || echo -e "${red}Gagal clone repo${neutral}"

    cat >/root/BotVPN2/.env <<EOF
BOT_TOKEN=$token
USER_ID=$adminid
NAMA_STORE=$namastore
PORT=50123
DATA_QRIS=$dataqris
MERCHANT_ID=$merchantid
API_KEY=$apikey
EOF

    npm install --prefix /root/BotVPN2 sqlite3 express crypto telegraf axios dotenv

    cat >/etc/cron.d/server_sellvpn <<EOF
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
0 */1 * * * root curl -s -F chat_id="$adminid" -F document=@"/root/BotVPN2/sellvpn.db" "https://api.telegram.org/bot$token/sendDocument" >/dev/null 2>&1
EOF

    pm2 start /root/BotVPN2/app.js --name sellvpn
    pm2 save
    pm2 startup

    echo -e "${green}Bot berhasil diinstall dan berjalan.${neutral}"
    echo -e "Ketik ${bold_white}/start${neutral} atau ${bold_white}menu${neutral} di Telegram bot."
}

cek_status() {
    pm2 status | grep -q sellvpn && echo "aktif" || echo "nonaktif"
}

case "$1" in
    sellvpn)
        hapus_bot
        pasang_package
        setup_bot
        ;;
    
    *)
        echo -e "${red}Perintah tidak dikenal. Gunakan:${reset} ${yellow}bash install.sh sellvpn${reset} atau ${yellow}bash install.sh uninstall${reset}"
        ;;
esac
